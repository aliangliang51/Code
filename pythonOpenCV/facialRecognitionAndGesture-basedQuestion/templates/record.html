<!DOCTYPE html>
<html lang="zh-Hans">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>人脸数据采集与训练</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        .main-img {
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body class="bg-light">
    <nav class="navbar navbar-dark bg-dark shadow-sm">
        <div class="container-fluid">
            <a class="navbar-brand mb-0 h1" href="{{ url_for('index') }}"><i class="bi bi-camera-video"></i> 实时监控</a>
            <span class="text-white">数据采集与模型训练</span>
            <a href="{{ url_for('history') }}" class="btn btn-outline-light me-2">
                <i class="bi bi-clock-history"></i> 历史记录
            </a>
        </div>
    </nav>

    <div class="container mt-5">
        <h2 class="text-center text-success mb-4"><i class="bi bi-person-plus"></i> 人脸数据采集中心</h2>

        {% if error %}
        <div class="alert alert-danger text-center">{{ error }}</div>
        {% endif %}

        <div class="row">
            <div class="col-md-6 mb-4">
                <div class="card shadow-lg">
                    <div class="card-header bg-success text-white">实时预览 (请将人脸保持在框内)</div>
                    <div class="card-body text-center p-2">
                        <img class="main-img" src="{{ url_for('video_feed') }}" alt="实时视频流" width="100%" height="auto">
                    </div>
                </div>
            </div>

            <div class="col-md-6 mb-4">
                <div class="card shadow-lg h-100">
                    <div class="card-header bg-secondary text-white">操作与状态</div>
                    <div class="card-body">

                        <h5 class="card-title text-success">开始采集新数据 (目标: {{ state.target_count }} 张)</h5>
                        <form method="POST" action="{{ url_for('record_page') }}" class="mb-4">
                            <div class="input-group mb-3">
                                <input type="text" name="name" class="form-control" placeholder="请输入姓名" required {% if state.is_capturing %} disabled {% endif %}>
                                <button type="submit" class="btn btn-primary" {% if state.is_capturing %} disabled {% endif %}>
                                    <i class="bi bi-camera"></i> 开始录制
                                </button>
                            </div>
                        </form>

                        <hr>

                        <h5 class="card-title text-info">采集状态</h5>
                        <p>当前采集人: <strong id="capture-name">{% if state.is_capturing %}{{ state.capture_name }}{% else %}无{% endif %}</strong></p>
                        <p>采集进度:
                            <span id="capture-progress">
                                {% if state.is_capturing %}
                                    {{ state.capture_count }}/{{ state.target_count }}
                                {% else %}
                                    -
                                {% endif %}
                            </span>
                        </p>
                        <div class="progress mb-4">
                            <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated bg-success" role="progressbar"
                                 style="width: {% if state.target_count > 0 %}{{ (state.capture_count / state.target_count) * 100 }}{% else %}0{% endif %}%"
                                 aria-valuenow="{{ state.capture_count }}" aria-valuemin="0" aria-valuemax="{{ state.target_count }}">
                            </div>
                        </div>

                        <hr>

                        <h5 class="card-title text-warning">模型训练</h5>
                        <p class="text-muted">采集完新数据后，请点击下方按钮更新模型，否则新人无法被识别。</p>
                        <button id="train-btn" class="btn btn-warning w-100" onclick="trainModel()">
                            <i class="bi bi-cpu"></i> 训练模型
                        </button>
                        <div id="train-message" class="mt-2 text-center"></div>

                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 定时器用于更新录制状态
        function updateStatus() {
            fetch('{{ url_for("get_status") }}')
                .then(response => response.json())
                .then(data => {
                    const nameElement = document.getElementById('capture-name');
                    const progressElement = document.getElementById('capture-progress');
                    const progressBar = document.getElementById('progress-bar');
                    const target = data.target_count;
                    const count = data.capture_count;
                    const isCapturing = data.is_capturing;
                    const recordInput = document.querySelector('input[name="name"]');
                    const recordButton = document.querySelector('button[type="submit"]');

                    if (isCapturing) {
                        nameElement.innerHTML = `<strong>${data.capture_name}</strong> (ID: ${data.capture_id})`;
                        progressElement.textContent = `${count}/${target}`;
                        const percentage = (count / target) * 100;
                        progressBar.style.width = `${percentage}%`;
                        progressBar.setAttribute('aria-valuenow', count);

                        recordInput.disabled = true;
                        recordButton.disabled = true;

                    } else {
                        // 录制完成或未开始
                        nameElement.innerHTML = '无';
                        progressElement.textContent = '-';
                        progressBar.style.width = '0%';

                        recordInput.disabled = false;
                        recordButton.disabled = false;

                        // 如果是刚完成录制，给出提示
                        if (count >= target && target > 0) {
                             document.getElementById('train-message').innerHTML = '<span class="text-danger">人脸录制已完成，请立即训练模型！</span>';
                        }
                    }
                })
                .catch(error => console.error('Error fetching status:', error));
        }

        // 异步调用训练模型路由
        function trainModel() {
            const trainBtn = document.getElementById('train-btn');
            const messageDiv = document.getElementById('train-message');

            trainBtn.disabled = true;
            messageDiv.innerHTML = '<span class="text-info"><i class="bi bi-arrow-clockwise"></i> 训练中，请稍候...</span>';

            fetch('{{ url_for("train_route") }}', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        messageDiv.innerHTML = '<span class="text-success"><i class="bi bi-check-circle"></i> 模型训练成功!</span>';
                    } else {
                        messageDiv.innerHTML = `<span class="text-danger"><i class="bi bi-x-circle"></i> 训练失败: ${data.message}</span>`;
                    }
                    trainBtn.disabled = false;
                })
                .catch(error => {
                    messageDiv.innerHTML = `<span class="text-danger"><i class="bi bi-x-circle"></i> 网络错误: ${error}</span>`;
                    trainBtn.disabled = false;
                });
        }

        setInterval(updateStatus, 1000); // 每秒更新一次状态
        updateStatus(); // 立即执行一次
    </script>
</body>
</html>